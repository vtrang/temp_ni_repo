<html>
<head>
	<style type="text/css">
		body
		{
			background-image: url("../images/overlays/paper.png");
		}
		input[type="text"]
		{
			width: 150px;
		}
		textarea
		{
			width:150px;
		}
	</style>

	<script type="text/javascript" src="../javascript/jquery-1.7.2.js"></script>
	<script type="text/javascript" src="../javascript/Main.js"></script>
	<script type="text/javascript" src="../javascript/toolbar.js"></script>


	<script type="text/javascript">
		const myBars = safari.extension.bars;
		var barWindow = null;
		//set the barWindow to our novaInitiaBar
		for (var i = 0; i < myBars.length; ++i) 
		{
			if(myBars[i].identifier == "novaInitiaBar")
			{
				barWindow = myBars[i].contentWindow;
			}
		}
		// //get ni_button
		// var ni_button;
		// for(var i=0; i<safari.extension.toolbarItems.length; i++)
		// {
		// 	var item = safari.extension.toolbarItems[i];
		// 	if(item.identifier == "nova-initia-button") ni_button = item;
		// }
		
		function dismiss()
{
	//hide popovers
	for(var i=0;i<safari.extension.popovers.length;i++)
    	{
    		var id = safari.extension.popovers[i].identifier;
    		if( id == "SignpostPlaced")
				{
					safari.extension.popovers[i].hide();
				}
		}
		//remove the popovers
	safari.extension.removePopover("SignpostPlaced");
	
}
		function setSign()
		{ 	
			var title = $("#title").val();
			var comments = $("#comments").val();
			var nsfw = $("#nsfw").is(":checked");
			placeSign(title,comments,nsfw);

			}

		function placeSign(title, comments, nsfw)
{
	// if(signpost_tool_amount>0 && at_a_page)
	alert(_user);
	var theParams = "Url="+urlencode(getURL());

	if(title!="") theParams = theParams+"&Title="+urlencode(title);
	if(comments!="") theParams = theParams+"&Comment="+urlencode(comments);
	
	theParams = theParams+"&NSFW="+nsfw;

	var theRes = send_request("http://data.nova-initia.com/rf/remog/page/"+getHashedURL(getURL())+"/"+getHashedDomain(getURL())+"/"+_user.inventory.sign_ID+".json","POST",theParams);

	if(theRes.status==201 || theRes.status==200)
	{
		var tmp_info = jQuery.parseJSON(theRes.responseText);

		//sign failed
	 	if(tmp_info.fail)
	 	{
		 	if(tmp_info.fail==true)
		 	{
				displayPopover("signFailed", "popovers/fail/signFailed.html", 202);
		 		// alert("Signpost Failed!");
		 		_user.inventory.signs -= 1;
				updateButtons();
			}
		}

		//successful?
		if(tmp_info.pageSet)
	 	{
		 	if(tmp_info.pageSet.ID)
		 	{
				displayPopover("signSet", "popovers/signSet.html", 202);
		 		// alert("Signpost Placed!");
		 		_user.inventory.signs -= 1;
				updateButtons();
		 	}
		}

		//failed
		if(tmp_info.result)
		{
			if (tmp_info.result=="Page Full")
			{
				alert("Page full, please try again later");
			}
			else
			{
				if(tmp_info.result=="Signpost Blocked!")
				{
					// NovaInitia.Toolbar.show_panel(spider_panel);
					_user.inventory.signs -= 1;
					updateButtons();
				}
			}
		}
		
		//error
		if(tmp_info.error)
		{
			// this.send_notification(tmp_info.error,"PRIORITY_INFO_LOW");
		}
	}
	else
	{
		alert("Signpost received a bad response!");
	}
}
	</script>
</head>
<h3>Place a Signpost</h3>
<body>
<form action="setSign()">
	<table>
		<tr>
			<td>Title:</td>
			<td><input type="text" id="title"></input></td>
		</tr>
		<tr>
			<td style="vertical-align:top;">Comments:</td>
			<td><textarea id="comments"></textarea></td>
		</tr>
		<tr>
			<td>NSFW?</td>
			<td><input type="checkbox" id="nsfw"></input></td>
			
		</tr>
		<tr>
			<td colspan="2" style="text-align: center;">
				<input type="button" value="Place Signpost" onclick="setSign()" />
				<input type="reset" value="Cancel" onclick="dismiss()" />
			</td>
		</tr>
	</table>
</form>
</body>
